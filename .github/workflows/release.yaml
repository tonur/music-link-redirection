name: Build & Publish

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  push:
    tags:
      - "v*"

jobs:
  # --------------------------------------------------------------------
  # 1) BUILD JOB — runs for PRs, pushes, and tags
  # --------------------------------------------------------------------
  build:
    name: Build XPI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build extension
        id: web-ext-build
        uses: kewisch/action-web-ext@v1
        with:
          cmd: build
          source: src
          filename: "{name}-{version}.xpi"
          ignoreFiles: '[ ]'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-xpi
          path: ${{ steps.web-ext-build.outputs.target }}

  # --------------------------------------------------------------------
  # 2) PRE-RELEASE JOB — only runs on main/master pushes (not tags)
  # --------------------------------------------------------------------
  prerelease:
    name: Create Pre-Release
    runs-on: ubuntu-latest
    needs: build
    if: github.ref_type == 'branch' && (github.ref_name == 'main' || github.ref_name == 'master')

    steps:
      - name: Download built XPI
        uses: actions/download-artifact@v4
        with:
          name: built-xpi
          path: xpi

      - name: Determine next prerelease tag
        id: version
        run: |
          LAST_TAG=$(git describe --tags --match "pre-*" --abbrev=0 2>/dev/null || echo "pre-0.0.0")
          IFS='.' read -ra PART <<< "${LAST_TAG#pre-}"
          MAJ=${PART[0]}
          MIN=${PART[1]}
          PATCH=$((PART[2] + 1))
          echo "tag=pre-$MAJ.$MIN.$PATCH" >> $GITHUB_OUTPUT

      - name: Create Pre-Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.version.outputs.tag }} \
            --prerelease \
            --title "Pre-Release ${{ steps.version.outputs.tag }}" \
            --notes "Automated prerelease" \
            xpi/*.xpi

  # --------------------------------------------------------------------
  # 3) OFFICIAL RELEASE — signing + AMO upload — only for tags
  # --------------------------------------------------------------------
  release:
    name: Sign & Publish Release
    runs-on: ubuntu-latest
    needs: build
    if: github.ref_type == 'tag'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download built XPI
        uses: actions/download-artifact@v4
        with:
          name: built-xpi
          path: .

      # --- Generate changelog from commits since previous tag ---
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 --always HEAD^ 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "changelog=$(git log --pretty=format:'- %s')" >> $GITHUB_OUTPUT
          else
            echo "changelog=$(git log $LAST_TAG..HEAD --pretty=format:'- %s')" >> $GITHUB_OUTPUT
          fi

      - name: Sign extension (Firefox AMO)
        id: web-ext-sign
        uses: kewisch/action-web-ext@v1
        with:
          cmd: sign
          source: .
          channel: listed
          apiKey: ${{ secrets.FIREFOX_JWT_ISSUER }}
          apiSecret: ${{ secrets.FIREFOX_JWT_SECRET }}

      - name: Upload signed XPI to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --notes "${{ steps.changelog.outputs.changelog }}" \
            "${{ steps.web-ext-sign.outputs.target }}"
